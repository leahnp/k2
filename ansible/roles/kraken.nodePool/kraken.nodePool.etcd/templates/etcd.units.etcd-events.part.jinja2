- name: kraken-etcd-events.service
  command: start
  content: |
    [Unit]
    Description=etcd-events
{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}
    After=kraken-ssl.service
    Requires=kraken-ssl.service
{% endif %}
{% for mount in cluster_node_tuple.1.nodeConfig.mounts %}
    After={{mount.path | replace('/', '-') | replace('-', '', 1)}}.mount
    Requires={{mount.path | replace('/', '-') | replace('-', '', 1)}}.mount
{% endfor %}
    After=kraken-networking.service
    Requires=kraken-networking.service
    [Service]
    EnvironmentFile=/etc/network-environment
    TimeoutStartSec=0
    RestartSec=15
    Restart=always
    KillMode=none
    ExecStartPre=/usr/bin/mkdir -p /ephemeral/events
    ExecStart=/usr/bin/rkt run --net=host \
     --stage1-path=/usr/lib/rkt/stage1-images/stage1-fly.aci \
     --insecure-options=image \
     --inherit-env=true \
{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}
     --volume ssl,kind=host,source=/etc/etcd-events/ssl,readOnly=true \
{% endif %}
     --volume data,kind=host,source=/ephemeral/events,readOnly=false \
     --volume resolv-conf,kind=host,source=/etc/resolv.conf \
     --mount volume=ssl,target=/etc/etcd-events/ssl \
     --mount volume=data,target=/ephemeral \
     --mount volume=resolv-conf,target=/etc/resolv.conf \
     quay.io/coreos/etcd:{{cluster_node_tuple.1.etcdEventsConfig.version}} \
     -- --data-dir /ephemeral/events \
     --name etcd-events{{cluster_node_tuple.1.name}}${DEFAULT_IPV4} \
{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}
     --peer-client-cert-auth \
     --peer-trusted-ca-file=/etc/etcd-events/ssl/peer-ca.pem \
     --peer-cert-file=/etc/etcd-events/ssl/peer.pem \
     --peer-key-file=/etc/etcd-events/ssl/peer-key.pem \
     --trusted-ca-file=/etc/etcd-events/ssl/server-ca.pem \
     --cert-file=/etc/etcd-events/ssl/server.pem \
     --key-file=/etc/etcd-events/ssl/server-key.pem \
     --client-cert-auth \
{% endif %}
     --discovery-srv {{cluster_node_tuple.1.name}}.{{cluster_node_tuple.0.name}}.internal \
     --initial-advertise-peer-urls {% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{cluster_node_tuple.1.etcdEventsConfig.peerPorts[0]}} \
     --initial-cluster-token {{cluster_node_tuple.1.etcdEventsConfig.clusterToken}} \
     --initial-cluster-state new \
     --advertise-client-urls {% for port in cluster_node_tuple.1.etcdEventsConfig.clientPorts %}{% if loop.index > 1 %},{% endif %}{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     --listen-client-urls {% for port in cluster_node_tuple.1.etcdEventsConfig.clientPorts %}{% if loop.index > 1 %},{% endif %}{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}https{% else %}http{% endif %}://127.0.0.1:{{port}},{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     --listen-peer-urls {% for port in cluster_node_tuple.1.etcdEventsConfig.peerPorts %}{% if loop.index > 1 %},{% endif %}{% if cluster_node_tuple.1.etcdEventsConfig.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     ---
    ExecStopPost=/usr/bin/rkt gc --mark-only
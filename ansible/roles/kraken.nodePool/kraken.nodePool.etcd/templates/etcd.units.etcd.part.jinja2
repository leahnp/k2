- name: kraken-{{config.name}}.service
  command: start
  content: |
    [Unit]
    Description={{config.name}}
{% if config.ssl == true %}
    After=kraken-ssl.service kraken-{{config.name}}-prediscovery.service
    Requires=kraken-ssl.service kraken-{{config.name}}-prediscovery.service
{% else %}
    After=kraken-{{config.name}}-prediscovery.service
    Requires=kraken-{{config.name}}-prediscovery.service
{% endif %}
{% for mount in cluster_node_tuple.1.nodeConfig.mounts %}
    After={{mount.path | replace('/', '-') | replace('-', '', 1)}}.mount
    Requires={{mount.path | replace('/', '-') | replace('-', '', 1)}}.mount
{% endfor %}
    After=kraken-networking.service
    Requires=kraken-networking.service
    [Service]
    EnvironmentFile=/etc/network-environment
    TimeoutStartSec=0
    RestartSec=15
    Restart=always
    KillMode=none
    ExecStartPre=/usr/bin/mkdir -p /ephemeral/{{config.name}}
    ExecStart=/usr/bin/rkt run --net=host \
     --stage1-path=/usr/lib/rkt/stage1-images/stage1-fly.aci \
     --insecure-options=image \
     --inherit-env=true \
{% if config.ssl == true %}
     --volume ssl,kind=host,source=/etc/{{config.name}}/ssl,readOnly=true \
{% endif %}
     --volume data,kind=host,source=/ephemeral/{{config.name}},readOnly=false \
     --volume resolv-conf,kind=host,source=/etc/resolv.conf \
     --mount volume=ssl,target=/etc/{{config.name}}/ssl \
     --mount volume=data,target=/ephemeral \
     --mount volume=resolv-conf,target=/etc/resolv.conf \
     quay.io/coreos/etcd:{{config.version}} \
     -- --data-dir /ephemeral/{{config.name}} \
     --name {{config.name}}{{cluster_node_tuple.1.name}}${DEFAULT_IPV4} \
{% if config.ssl == true %}
     --peer-client-cert-auth \
     --peer-trusted-ca-file=/etc/{{config.name}}/ssl/peer-ca.pem \
     --peer-cert-file=/etc/{{config.name}}/ssl/peer.pem \
     --peer-key-file=/etc/{{config.name}}/ssl/peer-key.pem \
     --trusted-ca-file=/etc/{{config.name}}/ssl/server-ca.pem \
     --cert-file=/etc/{{config.name}}/ssl/server.pem \
     --key-file=/etc/{{config.name}}/ssl/server-key.pem \
     --client-cert-auth \
{% endif %}
     --discovery-srv {{cluster_node_tuple.1.name}}.{{cluster_node_tuple.0.name}}.internal \
     --initial-advertise-peer-urls {% if config.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{config.peerPorts[0]}} \
{% if config.uuidToken is defined and config.uuidToken %}
     --initial-cluster-token {{ clusterUuidToken }} \
{% elif config.clusterToken is defined %}
     --initial-cluster-token {{ config.clusterToken }} \
{% endif %}
     --initial-cluster-state new \
     --advertise-client-urls {% for port in config.clientPorts %}{% if loop.index > 1 %},{% endif %}{% if config.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     --listen-client-urls {% for port in config.clientPorts %}{% if loop.index > 1 %},{% endif %}{% if config.ssl == true %}https{% else %}http{% endif %}://127.0.0.1:{{port}},{% if config.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     --listen-peer-urls {% for port in config.peerPorts %}{% if loop.index > 1 %},{% endif %}{% if config.ssl == true %}https{% else %}http{% endif %}://${DEFAULT_IPV4}:{{port}}{% endfor %} \
     ---
    ExecStopPost=/usr/bin/rkt gc --mark-only